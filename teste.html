<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promo Bilie - Ofertas em Tempo Real do Telegram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (estilos mantidos) ... */
    </style>
</head>
<body class="min-h-screen">

    <!-- ... (HTML mantido) ... -->

    <script>
        
        const TELEGRAM_CHANNEL = '@promobilie';
        
        // Elementos do DOM
        const connectionStatus = document.getElementById('connection-status');
        const offersContainer = document.getElementById('offers-container');
        const offersCount = document.getElementById('offers-count');
        const lastUpdateTime = document.getElementById('last-update-time');
        const nextUpdate = document.getElementById('next-update');
        const updateInfo = document.getElementById('update-info');
        
        // Estado
        let updateInterval;
        let updateCountdown = 300; // 5 minutos em segundos

        // Fun√ß√£o para atualizar status da conex√£o
        function updateConnectionStatus(text, type = 'info') {
            const colors = {
                info: 'text-green-300',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            connectionStatus.className = colors[type];
            connectionStatus.innerHTML = `<i class="fas fa-circle ${type === 'success' ? 'animate-pulse' : ''} mr-1"></i>${text}`;
        }

        // Fun√ß√£o para formatar hora
        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fun√ß√£o para calcular tempo decorrido
        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = Math.floor((now - new Date(timestamp)) / 1000);
            
            if (diff < 60) return 'agora mesmo';
            if (diff < 3600) return `${Math.floor(diff / 60)} min atr√°s`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} h atr√°s`;
            return `${Math.floor(diff / 86400)} d atr√°s`;
        }

        // Fun√ß√£o para buscar ofertas do Telegram
        async function loadTelegramOffers(forceUpdate = false) {
            try {
                updateConnectionStatus('Buscando ofertas mais recentes...', 'info');
                updateInfo.textContent = 'Buscando ofertas...';
                
                // Usar proxy para evitar problemas de CORS
                const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
                const telegramUrl = 'https://t.me/s/promobilie';
                
                const response = await fetch(`${proxyUrl}${encodeURIComponent(telegramUrl)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const html = await response.text();
                
                // Extrair ofertas do HTML
                const offers = extractOffersFromHTML(html);
                
                if (offers.length > 0) {
                    updateConnectionStatus(`‚úÖ ${offers.length} ofertas encontradas`, 'success');
                    updateInfo.textContent = `${offers.length} ofertas carregadas`;
                    offersCount.textContent = offers.length;
                    renderOffers(offers);
                } else {
                    throw new Error('Nenhuma oferta encontrada');
                }
                
            } catch (error) {
                console.warn('Erro ao buscar ofertas:', error);
                updateConnectionStatus('‚ö†Ô∏è Usando ofertas de exemplo', 'warning');
                loadExampleOffers();
            } finally {
                // Atualizar tempo
                const now = new Date();
                lastUpdateTime.textContent = formatTime(now);
                
                // Reiniciar contador
                updateCountdown = 300;
            }
        }

        // Extrair ofertas do HTML da p√°gina do Telegram
        function extractOffersFromHTML(html) {
            const offers = [];
            
            try {
                // Encontrar todas as mensagens na p√°gina
                const messageRegex = /<div class="tgme_widget_message[^"]*"[^>]*>([\s\S]*?)<div class="tgme_widget_message_footer"/g;
                const matches = html.matchAll(messageRegex);
                
                for (const match of matches) {
                    const messageHtml = match[1];
                    
                    // Extrair texto da mensagem
                    const textMatch = messageHtml.match(/<div class="tgme_widget_message_text[^>]*>([\s\S]*?)<\/div>/);
                    if (!textMatch) continue;
                    
                    let text = textMatch[1]
                        .replace(/<br\s*\/?>/gi, '\n')
                        .replace(/<[^>]*>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    // Extrair data
                    const timeMatch = messageHtml.match(/<time[^>]*datetime="([^"]*)"[^>]*>/);
                    const date = timeMatch ? new Date(timeMatch[1]).getTime() : Date.now();
                    
                    // Extrair link do bot√£o "Ver Oferta"
                    let link = 'https://t.me/promobilie';
                    const linkMatch = messageHtml.match(/<a[^>]*href="([^"]*)"[^>]*class="[^"]*tgme_widget_message_button[^"]*"/);
                    if (linkMatch && linkMatch[1]) {
                        link = linkMatch[1].startsWith('http') ? linkMatch[1] : `https://t.me${linkMatch[1]}`;
                    }
                    
                    // Processar a mensagem como oferta
                    const offer = processMessage(text, date, link);
                    if (offer) {
                        offers.push(offer);
                    }
                    
                    // Limitar a 6 ofertas
                    if (offers.length >= 6) break;
                }
            } catch (error) {
                console.warn('Erro ao extrair ofertas:', error);
            }
            
            return offers;
        }

        // Processar uma mensagem individual
        function processMessage(text, date, link) {
            if (!text || text.length < 10) return null;
            
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            if (lines.length < 2) return null;
            
            // Verificar se parece ser uma oferta
            const isOffer = text.includes('R$') || 
                           text.includes('desconto') || 
                           text.includes('promo√ß√£o') || 
                           text.includes('cupom') ||
                           text.includes('%') ||
                           text.toLowerCase().includes('off');
            
            if (!isOffer) return null;
            
            // T√≠tulo (primeira linha)
            let title = lines[0].trim();
            if (title.length > 50) {
                title = title.substring(0, 50) + '...';
            }
            
            // Pre√ßo
            let price = '';
            const priceMatch = text.match(/R\$\s?[\d.,]+/g);
            if (priceMatch && priceMatch.length > 0) {
                price = priceMatch[0];
            }
            
            // Loja
            let store = 'Loja Parceira';
            const textLower = text.toLowerCase();
            if (textLower.includes('amazon')) store = 'Amazon';
            else if (textLower.includes('mercado livre') || textLower.includes('ml')) store = 'Mercado Livre';
            else if (textLower.includes('shopee')) store = 'Shopee';
            else if (textLower.includes('aliexpress')) store = 'AliExpress';
            else if (textLower.includes('magalu')) store = 'Magazine Luiza';
            
            // Descri√ß√£o (primeiras 3 linhas)
            let description = lines.slice(0, 3).join(' ‚Ä¢ ');
            if (description.length > 100) {
                description = description.substring(0, 100) + '...';
            }
            
            // Determinar se √© nova (menos de 24 horas)
            const isNew = (Date.now() - date) < 86400000;
            
            return {
                title,
                description,
                price: price, // Pode ser string vazia
                store,
                link,
                timestamp: date,
                timeAgo: getTimeAgo(date),
                isNew,
                fullText: text
            };
        }

        // Renderizar ofertas
        function renderOffers(offers) {
            offersContainer.innerHTML = '';
            
            if (offers.length === 0) {
                offersContainer.innerHTML = `
                    <div class="col-span-3 glass-card p-8 text-center">
                        <i class="fas fa-inbox text-4xl text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Nenhuma oferta encontrada</h3>
                        <p class="text-slate-400 mb-4">As ofertas ser√£o carregadas em breve</p>
                        <a href="https://t.me/promobilie" target="_blank"
                           class="inline-flex items-center space-x-2 telegram-gradient text-white font-semibold py-2 px-4 rounded-xl">
                            <i class="fab fa-telegram"></i>
                            <span>Ver canal completo</span>
                        </a>
                    </div>
                `;
                return;
            }
            
            offers.forEach((offer, index) => {
                const card = document.createElement('div');
                card.className = `glass-card p-6 animate-fadeIn ${offer.isNew ? 'new-offer' : ''}`;
                card.style.animationDelay = `${index * 0.1}s`;
                
                // Cor baseada na loja
                let storeColor = 'bg-green-900/30 text-green-300';
                let storeIcon = 'fas fa-store';
                
                if (offer.store === 'Amazon') {
                    storeColor = 'bg-yellow-900/30 text-yellow-300';
                    storeIcon = 'fab fa-amazon';
                } else if (offer.store === 'Mercado Livre') {
                    storeColor = 'bg-blue-900/30 text-blue-300';
                    storeIcon = 'fas fa-shopping-cart';
                } else if (offer.store === 'Shopee') {
                    storeColor = 'bg-orange-900/30 text-orange-300';
                    storeIcon = 'fas fa-shopping-bag';
                } else if (offer.store === 'AliExpress') {
                    storeColor = 'bg-red-900/30 text-red-300';
                    storeIcon = 'fas fa-box';
                } else if (offer.store === 'Magazine Luiza') {
                    storeColor = 'bg-purple-900/30 text-purple-300';
                    storeIcon = 'fas fa-store-alt';
                }
                
                // Exibe valor apenas se existir
                const priceHtml = offer.price ? `
                    <div class="flex items-baseline space-x-2">
                        <span class="text-2xl font-black text-green-400">${offer.price}</span>
                        ${offer.isNew ? '<span class="text-xs text-green-300 font-bold">HOJE!</span>' : ''}
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${storeColor}">
                                        <i class="${storeIcon} mr-1"></i>${offer.store}
                                    </span>
                                    <span class="text-xs text-slate-400">
                                        <i class="far fa-clock mr-1"></i>${offer.timeAgo}
                                    </span>
                                    ${offer.isNew ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-900/30 text-green-300">NOVO</span>' : ''}
                                </div>
                                <h3 class="text-lg font-bold text-white mb-3 line-clamp-2">${offer.title}</h3>
                            </div>
                        </div>
                        
                        <p class="text-slate-300 text-sm mb-4 flex-grow line-clamp-3">${offer.description}</p>
                        
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-800">
                            ${priceHtml}
                            
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <a href="${offer.link}" target="_blank"
                                   class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors text-center">
                                    Ver Oferta
                                </a>
                                <a href="https://whatsapp.com/channel/0029Vb7EcLbFMqrdYt0KNM0Y" target="_blank"
                                   class="px-4 py-2 whatsapp-gradient text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity text-center">
                                    <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                
                offersContainer.appendChild(card);
            });
        }

        // Ofertas de exemplo
        function loadExampleOffers() {
            const exampleOffers = [
                {
                    title: "üî• PROMO√á√ÉO REL√ÇMPAGO - AMAZON",
                    description: "Smart TV 50'' 4K UHD com pre√ßo especial por tempo limitado. Aproveite!",
                    price: "R$ 1.799",
                    store: "Amazon",
                    link: "https://t.me/promobilie",
                    timeAgo: "15 min atr√°s",
                    isNew: true
                },
                {
                    title: "üéØ OFERTA EXCLUSIVA - MERCADO LIVRE",
                    description: "Notebook Gamer com 30% de desconto + frete gr√°tis para todo Brasil",
                    price: "R$ 3.299",
                    store: "Mercado Livre",
                    link: "https://t.me/promobilie",
                    timeAgo: "1 h atr√°s",
                    isNew: true
                },
                {
                    title: "üì± SUPER DESCONTO - SHOPEE",
                    description: "iPhone 14 com cashback especial e parcelamento sem juros em 12x",
                    price: "R$ 4.499",
                    store: "Shopee",
                    link: "https://t.me/promobilie",
                    timeAgo: "2 h atr√°s",
                    isNew: false
                }
            ];
            
            updateInfo.textContent = "3 ofertas de demonstra√ß√£o";
            offersCount.textContent = "3";
            renderOffers(exampleOffers);
        }

        // Inicializar contador de atualiza√ß√£o
        function startUpdateCountdown() {
            clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                updateCountdown--;
                
                const minutes = Math.floor(updateCountdown / 60);
                const seconds = updateCountdown % 60;
                
                nextUpdate.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (updateCountdown <= 0) {
                    loadTelegramOffers();
                }
            }, 1000);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar ofertas imediatamente
            loadTelegramOffers();
            
            // Iniciar contador
            startUpdateCountdown();
            
            // Atualizar a cada 5 minutos
            setInterval(() => loadTelegramOffers(), 5 * 60 * 1000);
        });

        // Expor fun√ß√£o globalmente para o bot√£o
        window.loadTelegramOffers = loadTelegramOffers;
    </script>
</body>
</html>
