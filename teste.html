<script>
    // Configurações
    const TELEGRAM_BOT_TOKEN = '7735068192:AAG7DFrOE3G8MK4xwO_WX1atjlXe_9D4RfI';
    
    // Elementos do DOM
    const connectionStatus = document.getElementById('connection-status');
    const offersContainer = document.getElementById('offers-container');
    
    // Função para buscar as últimas mensagens do canal usando a API do Telegram
    async function loadTelegramOffers(forceUpdate = false) {
        try {
            connectionStatus.innerHTML = '<i class="fas fa-circle animate-pulse mr-1"></i>Buscando últimas ofertas...';
            
            // Buscar as atualizações recentes do bot
            const updatesUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?limit=100`;
            
            const response = await fetch(updatesUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.ok || !data.result) {
                throw new Error('Resposta inválida da API do Telegram');
            }
            
            console.log('Total de updates:', data.result.length);
            
            // Filtrar apenas mensagens de canal (channel_post) que tenham conteúdo
            const channelMessages = data.result
                .filter(update => {
                    const channelPost = update.channel_post;
                    // Verificar se é uma mensagem de canal com conteúdo (text ou caption)
                    return channelPost && 
                           (channelPost.text || channelPost.caption);
                })
                .map(update => {
                    const post = update.channel_post;
                    // Extrair informações do canal (se disponível)
                    const chatUsername = post.chat?.username || 'promobilie'; // Fallback para o canal principal
                    return {
                        text: post.text || post.caption || '',
                        date: post.date * 1000,
                        message_id: post.message_id,
                        chat_username: chatUsername
                    };
                })
                .sort((a, b) => b.date - a.date) // Ordenar do mais recente para o mais antigo
                .slice(0, 6); // Pegar apenas as 6 mais recentes
            
            console.log('Mensagens de canal encontradas:', channelMessages.length);
            
            if (channelMessages.length === 0) {
                throw new Error('Nenhuma mensagem de canal encontrada');
            }
            
            // Processar as mensagens para extrair informações das ofertas
            const offers = processMessages(channelMessages);
            
            // Renderizar as ofertas
            renderOffers(offers);
            
            connectionStatus.innerHTML = '<i class="fas fa-circle text-green-400 mr-1"></i>' + 
                `${offers.length} ofertas carregadas do canal`;
                
        } catch (error) {
            console.error('Erro ao buscar ofertas:', error);
            connectionStatus.innerHTML = '<i class="fas fa-circle text-yellow-400 mr-1"></i>' + 
                'Usando ofertas de exemplo';
            
            // Carregar ofertas de exemplo em caso de erro
            loadExampleOffers();
        }
    }

    // Função para processar mensagens e extrair informações das ofertas
    function processMessages(messages) {
        return messages.map(msg => {
            const text = msg.text;
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            
            // Extrair título (primeira linha ou primeira parte)
            let title = lines[0] || 'Nova Oferta';
            if (title.length > 60) {
                title = title.substring(0, 60) + '...';
            }
            
            // Extrair preço (se existir)
            let price = '';
            const priceMatch = text.match(/R\$\s?[\d.,]+/g);
            if (priceMatch && priceMatch.length > 0) {
                price = priceMatch[0];
            }
            
            // Extrair loja (detectar por palavras-chave)
            let store = 'Loja Parceira';
            const textLower = text.toLowerCase();
            if (textLower.includes('amazon')) store = 'Amazon';
            else if (textLower.includes('mercado livre') || textLower.includes('ml')) store = 'Mercado Livre';
            else if (textLower.includes('shopee')) store = 'Shopee';
            else if (textLower.includes('aliexpress')) store = 'AliExpress';
            else if (textLower.includes('magalu') || textLower.includes('magazine luiza')) store = 'Magazine Luiza';
            
            // Extrair descrição (primeiras 2-3 linhas)
            let description = '';
            if (lines.length > 1) {
                description = lines.slice(1, 3).join(' • ');
                if (description.length > 100) {
                    description = description.substring(0, 100) + '...';
                }
            }
            
            // Determinar se é nova (menos de 24 horas)
            const isNew = (Date.now() - msg.date) < 24 * 60 * 60 * 1000;
            
            // Calcular tempo decorrido
            const timeAgo = getTimeAgo(msg.date);
            
            // Gerar link para a mensagem no Telegram
            let link = `https://t.me/${msg.chat_username}/${msg.message_id}`;
            
            return {
                title,
                description: description || 'Confira esta oferta exclusiva!',
                price: price, // Pode ser string vazia
                store,
                link,
                timeAgo,
                isNew,
                date: msg.date
            };
        });
    }

    // ... (restante do código permanece igual)

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        // Carregar ofertas imediatamente
        loadTelegramOffers();
        
        // Atualizar a cada 5 minutos
        setInterval(() => loadTelegramOffers(), 5 * 60 * 1000);
    });

    // Expor função globalmente para o botão
    window.loadTelegramOffers = loadTelegramOffers;
</script>
