<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promo Bilie - Ofertas em Tempo Real do Telegram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (estilos mantidos) ... */
    </style>
</head>
<body class="min-h-screen">

    <!-- ... (HTML mantido) ... -->

    <script>
        // Configurações
        const TELEGRAM_CHANNEL = '@promobilie';
        
        // Elementos do DOM
        const connectionStatus = document.getElementById('connection-status');
        const offersContainer = document.getElementById('offers-container');
        const offersCount = document.getElementById('offers-count');
        const lastUpdateTime = document.getElementById('last-update-time');
        const nextUpdate = document.getElementById('next-update');
        const updateInfo = document.getElementById('update-info');
        
        // Estado
        let updateInterval;
        let updateCountdown = 300;

        // ... (funções auxiliares mantidas) ...

        // Função para processar mensagens do Telegram - VERSÃO MELHORADA
        function processTelegramMessages(messages) {
            // Primeiro, filtrar apenas mensagens com texto
            const textMessages = messages
                .filter(msg => {
                    const text = msg.text || msg.caption;
                    return text && text.trim().length > 10;
                })
                .map(msg => {
                    const text = (msg.text || msg.caption).trim();
                    const date = msg.date * 1000;
                    
                    // Extrair informações da oferta
                    const lines = text.split('\n').filter(line => line.trim().length > 0);
                    
                    // Identificar se é uma oferta (contém palavras-chave)
                    const isOffer = text.includes('R$') || 
                                   text.includes('desconto') || 
                                   text.includes('promoção') || 
                                   text.includes('cupom') ||
                                   text.includes('%') ||
                                   text.includes('off') ||
                                   text.includes('OFF');
                    
                    if (!isOffer && lines.length < 2) return null;
                    
                    // Título (primeira linha ou primeira parte)
                    let title = lines[0] || 'Nova Oferta';
                    if (title.length > 50) {
                        title = title.substring(0, 50) + '...';
                    }
                    
                    // Preço - MODIFICADO: deixa em branco se não encontrar
                    let price = '';
                    const priceMatch = text.match(/R\$\s?[\d.,]+/g);
                    if (priceMatch && priceMatch.length > 0) {
                        price = priceMatch[0];
                    }
                    
                    // Loja
                    let store = 'Loja Parceira';
                    const textLower = text.toLowerCase();
                    if (textLower.includes('amazon')) store = 'Amazon';
                    else if (textLower.includes('mercado livre') || textLower.includes('ml')) store = 'Mercado Livre';
                    else if (textLower.includes('shopee')) store = 'Shopee';
                    else if (textLower.includes('aliexpress')) store = 'AliExpress';
                    else if (textLower.includes('magalu')) store = 'Magazine Luiza';
                    
                    // Link
                    let link = '';
                    const urlMatch = text.match(/https?:\/\/[^\s]+/g);
                    if (urlMatch && urlMatch.length > 0) {
                        link = urlMatch[0];
                    } else {
                        link = `https://t.me/${TELEGRAM_CHANNEL.replace('@', '')}`;
                    }
                    
                    // Descrição (primeiras 3 linhas)
                    let description = lines.slice(0, 3).join(' • ');
                    if (description.length > 100) description = description.substring(0, 100) + '...';
                    
                    // Determinar se é nova (menos de 1 hora)
                    const isNew = (Date.now() - date) < 3600000;
                    
                    return {
                        title,
                        description,
                        price: price, // MODIFICADO: mantém string vazia se não tiver preço
                        store,
                        link,
                        timestamp: date,
                        timeAgo: getTimeAgo(date),
                        isNew,
                        fullText: text
                    };
                })
                .filter(msg => msg !== null);
                
            // Ordenar por data (mais recente primeiro)
            textMessages.sort((a, b) => b.timestamp - a.timestamp);
            
            // Pegar apenas as 6 mais recentes
            return textMessages.slice(0, 6);
        }

        // Função para buscar ofertas do Telegram - VERSÃO MODIFICADA (sem verificação de duplicatas)
        async function loadTelegramOffers(forceUpdate = false) {
            try {
                updateConnectionStatus('Buscando ofertas mais recentes...', 'info');
                updateInfo.textContent = 'Buscando ofertas mais recentes...';
                
                // Usar CORS proxy
                const corsProxy = 'https://api.allorigins.win/get?url=';
                
                // URL para pegar as últimas 50 mensagens do canal
                const encodedUrl = encodeURIComponent(
                    `https://api.telegram.org/bot7735068192:AAG7DFrOE3G8MK4xwO_WX1atjlXe_9D4RfI/getUpdates?offset=-50&limit=50&timeout=1`
                );
                
                const response = await fetch(`${corsProxy}${encodedUrl}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const telegramData = JSON.parse(data.contents);
                
                if (telegramData.ok && telegramData.result) {
                    // Filtrar apenas mensagens do canal @promobilie
                    const channelMessages = telegramData.result
                        .filter(update => {
                            // Verificar se é uma mensagem do canal
                            const channelPost = update.channel_post;
                            return channelPost && 
                                   channelPost.chat && 
                                   channelPost.chat.username === 'promobilie' &&
                                   (channelPost.text || channelPost.caption);
                        })
                        .map(update => {
                            const post = update.channel_post;
                            return {
                                text: post.text || post.caption,
                                date: post.date
                            };
                        });
                    
                    if (channelMessages.length > 0) {
                        // Processar mensagens
                        const offers = processTelegramMessages(channelMessages);
                        
                        if (offers.length > 0) {
                            updateConnectionStatus(`✅ ${offers.length} ofertas recentes encontradas`, 'success');
                            updateInfo.textContent = `${offers.length} ofertas carregadas`;
                            offersCount.textContent = offers.length;
                            renderOffers(offers);
                        } else {
                            // Se não encontrou ofertas, tentar método alternativo
                            await tryAlternativeMethod();
                        }
                    } else {
                        // Se não encontrou mensagens do canal, tentar método alternativo
                        await tryAlternativeMethod();
                    }
                } else {
                    throw new Error('Resposta inválida da API');
                }
                
            } catch (error) {
                console.warn('Erro ao buscar ofertas:', error);
                await tryAlternativeMethod();
            } finally {
                // Atualizar tempo
                const now = new Date();
                lastUpdateTime.textContent = formatTime(now);
                
                // Reiniciar contador
                updateCountdown = 300;
            }
        }

        // ... (outras funções mantidas) ...

        // Renderizar ofertas - MODIFICADO para campo de valor opcional
        function renderOffers(offers) {
            offersContainer.innerHTML = '';
            
            if (offers.length === 0) {
                offersContainer.innerHTML = `
                    <div class="col-span-3 glass-card p-8 text-center">
                        <i class="fas fa-inbox text-4xl text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Nenhuma oferta encontrada</h3>
                        <p class="text-slate-400 mb-4">As ofertas serão carregadas em breve</p>
                        <a href="https://t.me/promobilie" target="_blank"
                           class="inline-flex items-center space-x-2 telegram-gradient text-white font-semibold py-2 px-4 rounded-xl">
                            <i class="fab fa-telegram"></i>
                            <span>Ver canal completo</span>
                        </a>
                    </div>
                `;
                return;
            }
            
            offers.forEach((offer, index) => {
                const card = document.createElement('div');
                card.className = `glass-card p-6 animate-fadeIn ${offer.isNew ? 'new-offer' : ''}`;
                card.style.animationDelay = `${index * 0.1}s`;
                
                // Cor baseada na loja
                let storeColor = 'bg-green-900/30 text-green-300';
                let storeIcon = 'fas fa-store';
                
                if (offer.store === 'Amazon') {
                    storeColor = 'bg-yellow-900/30 text-yellow-300';
                    storeIcon = 'fab fa-amazon';
                } else if (offer.store === 'Mercado Livre') {
                    storeColor = 'bg-blue-900/30 text-blue-300';
                    storeIcon = 'fas fa-shopping-cart';
                } else if (offer.store === 'Shopee') {
                    storeColor = 'bg-orange-900/30 text-orange-300';
                    storeIcon = 'fas fa-shopping-bag';
                } else if (offer.store === 'AliExpress') {
                    storeColor = 'bg-red-900/30 text-red-300';
                    storeIcon = 'fas fa-box';
                } else if (offer.store === 'Magazine Luiza') {
                    storeColor = 'bg-purple-900/30 text-purple-300';
                    storeIcon = 'fas fa-store-alt';
                }
                
                // MODIFICADO: exibe valor apenas se existir
                const priceHtml = offer.price ? `
                    <div class="flex items-baseline space-x-2">
                        <span class="text-2xl font-black text-green-400">${offer.price}</span>
                        ${offer.isNew ? '<span class="text-xs text-green-300 font-bold">HOJE!</span>' : ''}
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${storeColor}">
                                        <i class="${storeIcon} mr-1"></i>${offer.store}
                                    </span>
                                    <span class="text-xs text-slate-400">
                                        <i class="far fa-clock mr-1"></i>${offer.timeAgo}
                                    </span>
                                    ${offer.isNew ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-900/30 text-green-300">NOVO</span>' : ''}
                                </div>
                                <h3 class="text-lg font-bold text-white mb-3 line-clamp-2">${offer.title}</h3>
                            </div>
                        </div>
                        
                        <p class="text-slate-300 text-sm mb-4 flex-grow line-clamp-3">${offer.description}</p>
                        
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-800">
                            ${priceHtml}
                            
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <a href="${offer.link}" target="_blank"
                                   class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors text-center">
                                    Ver Oferta
                                </a>
                                <a href="https://whatsapp.com/channel/0029Vb7EcLbFMqrdYt0KNM0Y" target="_blank"
                                   class="px-4 py-2 whatsapp-gradient text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity text-center">
                                    <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                
                offersContainer.appendChild(card);
            });
        }

        // ... (restante do código mantido) ...

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar ofertas imediatamente
            loadTelegramOffers();
            
            // Iniciar contador
            startUpdateCountdown();
            
            // Atualizar a cada 5 minutos
            setInterval(() => loadTelegramOffers(), 5 * 60 * 1000);
        });

        // Expor função globalmente para o botão
        window.loadTelegramOffers = loadTelegramOffers;
    </script>
</body>
</html>
